name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [ main, develop ]

jobs:
  pr-validation:
    name: PR Validation
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Check PR title
      run: |
        PR_TITLE="${{ github.event.pull_request.title }}"
        # Check for conventional commit format
        if [[ ! "$PR_TITLE" =~ ^(feat|fix|docs|style|refactor|perf|test|chore|ci)(\(.+\))?:.+ ]]; then
          echo "::warning::PR title should follow conventional commit format"
          echo "Example: 'feat: add new detection pattern' or 'fix(api): resolve endpoint bug'"
        fi
    
    - name: Check PR description
      run: |
        if [ -z "${{ github.event.pull_request.body }}" ]; then
          echo "::error::PR description is empty. Please provide a description."
          exit 1
        fi
    
    - name: Check branch name
      run: |
        BRANCH="${{ github.head_ref }}"
        if [[ ! "$BRANCH" =~ ^(feature|bugfix|hotfix|refactor|docs)/.+ ]]; then
          echo "::warning::Branch name should follow naming convention: feature/*, bugfix/*, etc."
        fi

  changes-detection:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      code: ${{ steps.filter.outputs.code }}
      docs: ${{ steps.filter.outputs.docs }}
      tests: ${{ steps.filter.outputs.tests }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check changed files
      uses: dorny/paths-filter@v3
      id: filter
      with:
        filters: |
          code:
            - '*.py'
            - 'requirements.txt'
          docs:
            - '*.md'
          tests:
            - 'test_*.py'

  quick-test:
    name: Quick Test Suite
    runs-on: ubuntu-latest
    needs: changes-detection
    if: false  # DISABLED
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-xdist
        pip install -r requirements.txt
    
    - name: Run tests in parallel
      run: |
        pytest test_detector.py -n auto -v --tb=short

  security-check:
    name: Security Check
    runs-on: ubuntu-latest
    needs: changes-detection
    if: false  # DISABLED
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Run Bandit
      run: |
        pip install bandit
        bandit -r *.py -ll
    
    - name: Check for secrets
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: ${{ github.event.pull_request.base.sha }}
        head: ${{ github.event.pull_request.head.sha }}

  code-review:
    name: Automated Code Review
    runs-on: ubuntu-latest
    needs: changes-detection
    if: needs.changes-detection.outputs.code == 'true'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install review tools
      run: |
        pip install flake8 pylint radon
    
    - name: Run code review
      run: |
        echo "## Automated Code Review" > review-comment.md
        echo "" >> review-comment.md
        
        echo "### Complexity Analysis" >> review-comment.md
        radon cc *.py -s -a >> review-comment.md || true
        
        echo "" >> review-comment.md
        echo "### Style Issues" >> review-comment.md
        flake8 *.py --max-line-length=127 --statistics >> review-comment.md || true
    
    - name: Comment PR
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const comment = fs.readFileSync('review-comment.md', 'utf8');
          github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: comment
          });
      continue-on-error: true

  test-coverage:
    name: Test Coverage
    runs-on: ubuntu-latest
    needs: changes-detection
    if: false  # DISABLED
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov
        pip install -r requirements.txt
    
    - name: Run tests with coverage
      run: |
        pytest test_detector.py -v --cov=prompt_injection_detector --cov-report=term --cov-report=html
    
    - name: Coverage comment
      uses: py-cov-action/python-coverage-comment-action@v3
      with:
        GITHUB_TOKEN: ${{ github.token }}
      continue-on-error: true

  docs-check:
    name: Documentation Check
    runs-on: ubuntu-latest
    needs: changes-detection
    if: needs.changes-detection.outputs.docs == 'true'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check markdown links
      uses: gaurav-nelson/github-action-markdown-link-check@v1
      with:
        use-quiet-mode: 'yes'
        use-verbose-mode: 'no'
      continue-on-error: true
    
    - name: Lint markdown
      uses: nosborn/github-action-markdown-cli@v3.3.0
      with:
        files: .
        config_file: .markdownlint.json
      continue-on-error: true

  size-check:
    name: Bundle Size Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check file sizes
      run: |
        echo "## File Size Report" > size-report.md
        echo "" >> size-report.md
        echo "| File | Size |" >> size-report.md
        echo "|------|------|" >> size-report.md
        for file in *.py *.md; do
          if [ -f "$file" ]; then
            size=$(du -h "$file" | cut -f1)
            echo "| $file | $size |" >> size-report.md
          fi
        done
        
        cat size-report.md

  pr-summary:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [pr-validation, quick-test, security-check, test-coverage]
    if: always()
    
    steps:
    - name: Create summary
      run: |
        echo "# PR Check Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Results" >> $GITHUB_STEP_SUMMARY
        echo "- Validation: ${{ needs.pr-validation.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Quick Tests: ${{ needs.quick-test.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Security: ${{ needs.security-check.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Coverage: ${{ needs.test-coverage.result }}" >> $GITHUB_STEP_SUMMARY
