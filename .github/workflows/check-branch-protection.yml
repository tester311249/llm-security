name: Branch Protection Validation

# SECURITY: This workflow validates branch protection configuration
# - Read-only permissions for validation and drift detection
# - PR validation provides feedback without making changes
# - Apply job requires manual approval and runs only on main

on:
  push:
    branches: [main]
    paths:
      - '.github/branch-protection.yml'
      - 'config/branch-protection.json'  # Legacy support
      - '.github/workflows/check-branch-protection.yml'
      - 'scripts/repocheck'
      - 'scripts/validate-schema.sh'
  pull_request:
    paths:
      - '.github/branch-protection.yml'
      - 'config/branch-protection.json'  # Legacy support
      - '.github/workflows/check-branch-protection.yml'
      - 'scripts/repocheck'
      - 'scripts/validate-schema.sh'
  schedule:
    - cron: '0 2 * * 1'  # Weekly Monday 2 AM - drift detection
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'validate'
        type: choice
        options:
          - validate
          - apply
          - show-current

jobs:
  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Install yq for YAML parsing
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
      
      - name: Detect configuration file
        id: detect-config
        run: |
          if [ -f ".github/branch-protection.yml" ]; then
            echo "config_file=.github/branch-protection.yml" >> $GITHUB_OUTPUT
            echo "config_type=yaml" >> $GITHUB_OUTPUT
            echo "üìã Using YAML configuration"
          elif [ -f "config/branch-protection.json" ]; then
            echo "config_file=config/branch-protection.json" >> $GITHUB_OUTPUT
            echo "config_type=json" >> $GITHUB_OUTPUT
            echo "üìã Using legacy JSON configuration"
          else
            echo "‚ùå No configuration file found"
            exit 1
          fi
      
      - name: Validate configuration schema
        run: |
          echo "üîç Validating configuration schema..."
          ./scripts/validate-schema.sh ${{ steps.detect-config.outputs.config_file }}
      
      - name: Show configuration
        run: |
          echo "üìÑ Current configuration:"
          if [ "${{ steps.detect-config.outputs.config_type }}" = "yaml" ]; then
            echo "\`\`\`yaml"
            cat ${{ steps.detect-config.outputs.config_file }}
            echo "\`\`\`"
          else
            echo "\`\`\`json"
            jq '.' ${{ steps.detect-config.outputs.config_file }}
            echo "\`\`\`"
          fi

  pr-feedback:
    name: PR Drift Feedback
    needs: validate
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Install yq for YAML parsing
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
      
      - name: Detect configuration file
        id: detect-config
        run: |
          if [ -f ".github/branch-protection.yml" ]; then
            echo "config_file=.github/branch-protection.yml" >> $GITHUB_OUTPUT
          elif [ -f "config/branch-protection.json" ]; then
            echo "config_file=config/branch-protection.json" >> $GITHUB_OUTPUT
          fi
      
      - name: Check for drift
        id: check
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîç Checking for configuration drift..."
          # Run repocheck and capture output
          if ./scripts/repocheck ${{ github.repository }} ${{ steps.detect-config.outputs.config_file }} json > drift-result.json 2>&1; then
            echo "drift=false" >> $GITHUB_OUTPUT
            echo "‚úÖ No drift detected"
          else
            echo "drift=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  Drift detected"
          fi
      
      - name: Comment on PR with drift details
        if: steps.check.outputs.drift == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DRIFT_COUNT=$(jq -r '.summary.mismatched_fields // 0' drift-result.json)
          
          cat > pr-comment.md << 'EOFMARKER'
          ## ‚ö†Ô∏è Branch Protection Drift Detected
          
          The proposed configuration differs from current branch protection settings.
          
          **Found **DRIFT_COUNT_PLACEHOLDER** mismatched field(s):**
          
          DRIFT_DETAILS_PLACEHOLDER
          
          ---
          
          **Action Required:**
          - Review the differences above carefully
          - Ensure changes align with security requirements
          - Request approval from security team before merging
          
          **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          EOFMARKER
          
          # Generate drift details
          DRIFT_DETAILS=$(jq -r '.differences[]? | "- **\(.field)**: actual=`\(.actual)`, expected=`\(.expected)`"' drift-result.json | head -20)
          
          # Replace placeholders
          sed -i "s/DRIFT_COUNT_PLACEHOLDER/$DRIFT_COUNT/g" pr-comment.md
          sed -i "s|DRIFT_DETAILS_PLACEHOLDER|$DRIFT_DETAILS|g" pr-comment.md
          
          gh pr comment ${{ github.event.pull_request.number }} --body-file pr-comment.md
      
      - name: Add labels to PR
        if: steps.check.outputs.drift == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr edit ${{ github.event.pull_request.number }} --add-label "config-drift,needs-review" || echo "‚ö†Ô∏è Could not add labels (may not exist)"
      
      - name: Comment success
        if: steps.check.outputs.drift == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body "## ‚úÖ No Branch Protection Drift

          The proposed configuration matches the current branch protection settings."

  show-current:
    name: Show Current Protection
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'show-current' || (github.event_name == 'workflow_dispatch' && github.event.inputs.action != 'apply' && github.event.inputs.action != 'validate')
    permissions:
      contents: read
    steps:
      - name: Get current branch protection
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîí Current branch protection for main:"
          gh api repos/${{ github.repository }}/branches/main/protection \
            --jq 'del(.url, .required_pull_request_reviews.url, .required_signatures.url, .enforce_admins.url)' \
            2>/dev/null || echo "‚ö†Ô∏è No branch protection currently configured"

  detect-drift:
    name: Detect Configuration Drift
    needs: validate
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    permissions:
      contents: read
      issues: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Install yq for YAML parsing
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
      
      - name: Detect configuration file
        id: detect-config
        run: |
          if [ -f ".github/branch-protection.yml" ]; then
            echo "config_file=.github/branch-protection.yml" >> $GITHUB_OUTPUT
          elif [ -f "config/branch-protection.json" ]; then
            echo "config_file=config/branch-protection.json" >> $GITHUB_OUTPUT
          fi
      
      - name: Compare configurations using repocheck
        id: drift
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîç Checking for configuration drift..."
          
          if ./scripts/repocheck ${{ github.repository }} ${{ steps.detect-config.outputs.config_file }} text; then
            echo "‚úÖ No drift detected - configuration matches"
            echo "drift=false" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è DRIFT DETECTED - Configuration mismatch!"
            echo "drift=true" >> $GITHUB_OUTPUT
            
            # Generate detailed report
            ./scripts/repocheck ${{ github.repository }} ${{ steps.detect-config.outputs.config_file }} json > drift-report.json
          fi
      
      - name: Upload drift report
        if: steps.drift.outputs.drift == 'true'
        uses: actions/upload-artifact@v3
        with:
          name: drift-report
          path: drift-report.json
      
      - name: Create drift issue
        if: steps.drift.outputs.drift == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if drift issue already exists
          EXISTING=$(gh issue list --label "drift-detection" --state open --json number --jq '.[0].number')
          
          # Generate drift details from report
          DRIFT_DETAILS="$(jq -r '.differences[]? | "- **\(.field)**: actual=`\(.actual)`, expected=`\(.expected)`"' drift-report.json 2>/dev/null || echo "See workflow artifacts for details")"
          
          if [ -z "$EXISTING" ]; then
            gh issue create \
              --title "‚ö†Ô∏è Branch Protection Drift Detected" \
              --label "drift-detection,security" \
              --body "Configuration drift detected between actual branch protection and desired configuration.
          
          ## Drift Details
          
          $DRIFT_DETAILS
          
          ## Action Required
          
          1. Review the differences above
          2. Determine if the live configuration or code configuration is correct
          3. Apply the correct configuration:
             - Update config file if live settings are correct
             - Run workflow_dispatch to apply config if file is correct
          
          ## Details
          
          - **Detected:** $(date -u +\"%Y-%m-%d %H:%M:%S UTC\")
          - **Configuration File:** ${{ steps.detect-config.outputs.config_file }}
          - **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          - **Report:** Download drift-report artifact from workflow run"
            echo "üìù Created new drift detection issue"
          else
            echo "‚ÑπÔ∏è Drift issue already exists: #$EXISTING"
            gh issue comment $EXISTING --body "Drift still detected on $(date -u +\"%Y-%m-%d %H:%M:%S UTC\")

          $DRIFT_DETAILS

          Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          fi

  apply:
    name: Apply Branch Protection
    needs: validate
    runs-on: ubuntu-latest
    
    # üîí CRITICAL SECURITY CONTROLS:
    # 1. Only runs after merge to main (never from PRs)
    # 2. Requires manual approval via GitHub Environment
    # 3. Validation must pass first
    if: |
      github.ref == 'refs/heads/main' && 
      github.event_name != 'pull_request' &&
      (github.event.inputs.action == 'apply' || github.event_name == 'push')
    
    # Requires manual approval from designated admins
    environment:
      name: branch-protection-admin
      url: https://github.com/${{ github.repository }}/settings/branches
    
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Install yq for YAML parsing
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
      
      - name: Detect and prepare configuration
        id: prepare-config
        run: |
          if [ -f ".github/branch-protection.yml" ]; then
            echo "config_file=.github/branch-protection.yml" >> $GITHUB_OUTPUT
            echo "‚úÖ Using YAML configuration"
            # Convert YAML to JSON for API
            yq eval -o=json '.branch_protection' .github/branch-protection.yml > /tmp/config.json
          elif [ -f "config/branch-protection.json" ]; then
            echo "config_file=config/branch-protection.json" >> $GITHUB_OUTPUT
            echo "‚úÖ Using legacy JSON configuration"
            cp config/branch-protection.json /tmp/config.json
          else
            echo "‚ùå No configuration file found"
            exit 1
          fi
      
      - name: Get current protection
        id: current
        env:
          GH_TOKEN: ${{ secrets.BRANCH_PROTECTION_TOKEN }}
        run: |
          echo "üìã Fetching current branch protection..."
          gh api repos/${{ github.repository }}/branches/main/protection \
            --jq 'del(.url, .required_pull_request_reviews.url, .required_signatures.url, .enforce_admins.url)' \
            > current-full.json 2>/dev/null || echo "{}" > current-full.json
          
          cat current-full.json
        continue-on-error: true
      
      - name: Show changes
        run: |
          echo "::notice::üîÑ Applying branch protection changes"
          echo ""
          echo "**Repository:** ${{ github.repository }}"
          echo "**Branch:** main"
          echo "**Triggered by:** ${{ github.actor }}"
          echo "**Event:** ${{ github.event_name }}"
          echo "**Config File:** ${{ steps.prepare-config.outputs.config_file }}"
          echo ""
          echo "**New Configuration:**"
          jq '.' /tmp/config.json
      
      - name: Apply protection rules
        id: apply
        env:
          GH_TOKEN: ${{ secrets.BRANCH_PROTECTION_TOKEN }}
        run: |
          echo "üîí Applying branch protection rules..."
          
          gh api repos/${{ github.repository }}/branches/main/protection \
            -X PUT \
            --input /tmp/config.json
          
          echo "‚úÖ Branch protection rules applied successfully"
      
      - name: Verify application
        env:
          GH_TOKEN: ${{ secrets.BRANCH_PROTECTION_TOKEN }}
        run: |
          echo "‚úÖ Verifying applied configuration..."
          sleep 2  # Brief delay for API propagation
          
          gh api repos/${{ github.repository }}/branches/main/protection \
            --jq '{
              required_pull_request_reviews: .required_pull_request_reviews,
              enforce_admins: .enforce_admins.enabled,
              required_conversation_resolution: .required_conversation_resolution.enabled
            }'
          
          echo "‚úÖ Configuration verified"
      
      - name: Audit log
        if: always()
        run: |
          echo "üìù AUDIT LOG"
          echo "============"
          echo "Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "Repository: ${{ github.repository }}"
          echo "Branch: main"
          echo "Action: Apply branch protection"
          echo "Actor: ${{ github.actor }}"
          echo "Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "Commit: ${{ github.sha }}"
          echo "Status: ${{ steps.apply.outcome }}"
          echo "============"

  notify:
    name: Notify Changes
    needs: apply
    runs-on: ubuntu-latest
    if: always() && needs.apply.result != 'skipped'
    permissions:
      contents: read
    steps:
      - name: Report status
        run: |
          if [ "${{ needs.apply.result }}" = "success" ]; then
            echo "::notice::‚úÖ Branch protection successfully updated"
          else
            echo "::error::‚ùå Branch protection update failed"
            exit 1
          fi
